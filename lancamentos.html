<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entradas e Saídas — Calendário</title>
  <style>
    body { font-family: sans-serif; background:#f4f4f4; margin:0; padding:1rem 1rem 1rem 1rem; }
    .calendar, .form, .entries { max-width:800px; margin:12px auto; background:#fff; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;gap:8px}
    .days{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-weight:bold}
    .dates{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
    .date{padding:10px;background:#e0e0e0;border-radius:6px;cursor:pointer;text-align:center; user-select:none;}
    .date:hover{background:#2196f3;color:#fff}
    .date.active, .date.today { background:#2196f3; color:#fff; font-weight:bold; }
    .blank{background:transparent; cursor:default}
    label{display:block;margin-top:10px}
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:8px;margin-top:4px;border-radius:4px;border:1px solid #ccc; box-sizing:border-box }
    button{padding:8px 10px;border-radius:6px;border:0;background:#4caf50;color:white;cursor:pointer}
    button:hover{opacity:0.95}
    .entry{border-bottom:1px solid #eee;padding:8px 0;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .entry .info{flex:1}
    .entry .actions{display:flex;gap:8px;align-items:center}
    .totals{font-weight:bold;margin-top:10px}
    .small-btn{background:#ef4444;padding:6px 8px;border-radius:6px}
    .muted{color:#666;font-size:0.9rem}
    @media (max-width:600px){ .days,.dates{grid-template-columns:repeat(7,1fr)} }
  </style>
</head>
<body>

  <div class="calendar">
    <h2 id="mesAno" style="text-align:center;margin-bottom:0.25rem"></h2>
    <div class="header">
      <div style="display:flex;gap:8px">
        <button onclick="mudarMes(-1)">⬅️ Mês anterior</button>
        <button onclick="mudarMes(1)">Próximo mês ➡️</button>
      </div>
    </div>

    <div class="days">
      <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
    </div>

    <div class="dates" id="diasCalendario"></div>
  </div>

  <div class="form" id="formulario" style="display:none;">
    <h3>Adicionar serviço para <span id="dataSelecionada"></span></h3>

    <label>Nome do Cliente:
      <input type="text" id="cliente" />
    </label>

    <label>Serviço:
      <textarea id="servico"></textarea>
    </label>

    <label>Valor (R$):
      <input type="number" id="valor" step="0.01" />
    </label>

    <label>Forma de Pagamento:
      <select id="formaPagamento">
        <option value="Dinheiro">Dinheiro</option>
        <option value="Pix">Pix</option>
        <option value="Débito">Débito</option>
        <option value="Troca">Troca</option>
        <option value="Parcelado 1x">Parcelado 1x</option>
        <option value="Parcelado 2x">Parcelado 2x</option>
        <option value="Parcelado 3x">Parcelado 3x</option>
        <option value="Parcelado 4x">Parcelado 4x</option>
        <option value="Parcelado 5x">Parcelado 5x</option>
        <option value="Parcelado 6x">Parcelado 6x</option>
      </select>
    </label>

    <label>Valor de Saída (R$):
      <input type="number" id="saida" step="0.01" />
    </label>

    <label>Motivo da Saída:
      <input type="text" id="motivo" />
    </label>

    <button onclick="adicionarServico()">Salvar</button>
  </div>

  <div class="entries">
    <h3>Serviços do Dia</h3>

    <div style="margin-bottom:12px; display:flex; gap:8px; justify-content:center;">
      <button onclick="exportarDados()" style="background:#2196f3; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Exportar dados</button>
      <button onclick="document.getElementById('importFile').click()" style="background:#4caf50; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Importar dados</button>
      <input type="file" id="importFile" accept=".json" style="display:none" />
    </div>

    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="removerMarcadosBtn" onclick="removerMarcados()" style="display:none;background:#ef4444">Remover selecionados</button>
    </div>
    <div id="listaServicos"></div>
    <div class="totals" id="totaisDia"></div>
    <div class="totals" id="totaisMes"></div>
  </div>

  <script>
    // Utilitários de data — usamos formato local para evitar problemas de timezone/UTC.
    function pad(n){ return String(n).padStart(2,'0'); }
    function formatDateLocal(d){
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function parseISOToLocalDate(iso){ const [y,m,day]=iso.split('-').map(Number); return new Date(y, m-1, day); }

    let dataAtual = new Date();
    let dataSelecionada = null;
    let dados = JSON.parse(localStorage.getItem('servicosData') || '{}');

    function salvarDados(){ localStorage.setItem('servicosData', JSON.stringify(dados)); }

    function mostrarCalendario(){
      const diasEl = document.getElementById('diasCalendario');
      const mesAnoEl = document.getElementById('mesAno');
      diasEl.innerHTML = '';

      const ano = dataAtual.getFullYear();
      const mes = dataAtual.getMonth();
      const primeiroDia = new Date(ano, mes, 1);
      const ultimoDia = new Date(ano, mes + 1, 0);
      const diaSemana = primeiroDia.getDay(); // 0-6

      mesAnoEl.textContent = primeiroDia.toLocaleString('pt-BR', { month:'long', year:'numeric' });

      // espaços em branco antes do primeiro dia
      for(let i=0;i<diaSemana;i++){
        const vazio = document.createElement('div');
        vazio.classList.add('blank');
        diasEl.appendChild(vazio);
      }

      for(let dia=1; dia<=ultimoDia.getDate(); dia++){
        const d = new Date(ano, mes, dia);
        const iso = formatDateLocal(d);
        const div = document.createElement('div');
        div.classList.add('date');
        if (dataSelecionada === iso) div.classList.add('active');

        // destacar hoje automaticamente
        const hoje = new Date();
        if(d.getFullYear() === hoje.getFullYear() &&
           d.getMonth() === hoje.getMonth() &&
           d.getDate() === hoje.getDate() &&
           dataSelecionada !== iso) {
          div.classList.add('today');
        }

        div.textContent = dia;
        div.onclick = () => {
          dataSelecionada = iso;
          document.getElementById('dataSelecionada').textContent = d.toLocaleDateString('pt-BR');
          document.getElementById('formulario').style.display = 'block';
          mostrarServicos();
          mostrarCalendario();
        };
        diasEl.appendChild(div);
      }

      mostrarResumoMensal();
    }

    function mudarMes(offset){
      dataAtual.setMonth(dataAtual.getMonth() + offset);
      mostrarCalendario();
    }

    function adicionarServico(){
      if(!dataSelecionada){
        alert('Selecione um dia no calendário primeiro.');
        return;
      }

      const cliente = document.getElementById('cliente').value.trim();
      const servico = document.getElementById('servico').value.trim();
      const valor = parseFloat(document.getElementById('valor').value) || 0;
      const formaPagamento = document.getElementById('formaPagamento').value;
      const saida = parseFloat(document.getElementById('saida').value) || 0;
      const motivo = document.getElementById('motivo').value.trim();

      if(!cliente || !servico){
        alert('Preencha o nome do cliente e o serviço.');
        return;
      }

      if(!dados[dataSelecionada]) dados[dataSelecionada] = [];

      dados[dataSelecionada].push({
        cliente,
        servico,
        valor,
        formaPagamento,
        saida,
        motivo
      });

      salvarDados();

      document.getElementById('cliente').value = '';
      document.getElementById('servico').value = '';
      document.getElementById('valor').value = '';
      document.getElementById('saida').value = '';
      document.getElementById('motivo').value = '';

      mostrarServicos();
      mostrarResumoMensal();
    }

    function mostrarServicos(){
      const lista = document.getElementById('listaServicos');
      lista.innerHTML = '';

      if(!dataSelecionada || !dados[dataSelecionada] || dados[dataSelecionada].length === 0){
        lista.innerHTML = '<p class="muted" style="text-align:center;">Nenhum serviço cadastrado neste dia.</p>';
        document.getElementById('totaisDia').textContent = '';
        return;
      }

      dados[dataSelecionada].forEach((item, index) => {
        const div = document.createElement('div');
        div.classList.add('entry');

        const info = document.createElement('div');
        info.classList.add('info');
        info.innerHTML = `<strong>${item.cliente}</strong> — ${item.servico}<br/>
          Valor: R$ ${item.valor.toFixed(2)} — ${item.formaPagamento}<br/>
          Saída: R$ ${item.saida.toFixed(2)} — ${item.motivo || '-'}
        `;

        const actions = document.createElement('div');
        actions.classList.add('actions');

        const btnDel = document.createElement('button');
        btnDel.classList.add('small-btn');
        btnDel.textContent = 'Excluir';
        btnDel.onclick = () => {
          if(confirm('Excluir este serviço?')){
            dados[dataSelecionada].splice(index,1);
            if(dados[dataSelecionada].length === 0) delete dados[dataSelecionada];
            salvarDados();
            mostrarServicos();
            mostrarResumoMensal();
            mostrarCalendario();
          }
        };

        actions.appendChild(btnDel);
        div.appendChild(info);
        div.appendChild(actions);

        lista.appendChild(div);
      });

      // Mostrar totais do dia
      let totalEntrada = 0;
      let totalSaida = 0;
      dados[dataSelecionada].forEach(item=>{
        totalEntrada += item.valor;
        totalSaida += item.saida;
      });

      document.getElementById('totaisDia').textContent =
        `Total entrada: R$ ${totalEntrada.toFixed(2)} | Total saída: R$ ${totalSaida.toFixed(2)}`;
    }

    function mostrarResumoMensal(){
      const ano = dataAtual.getFullYear();
      const mes = dataAtual.getMonth();

      let totalMesEntrada = 0;
      let totalMesSaida = 0;

      for(const dia in dados){
        const d = parseISOToLocalDate(dia);
        if(d.getFullYear() === ano && d.getMonth() === mes){
          dados[dia].forEach(item => {
            totalMesEntrada += item.valor;
            totalMesSaida += item.saida;
          });
        }
      }

      document.getElementById('totaisMes').textContent =
        `Total do mês: Entrada R$ ${totalMesEntrada.toFixed(2)} | Saída R$ ${totalMesSaida.toFixed(2)}`;
    }

    // Exporta os dados do localStorage para arquivo JSON
    function exportarDados(){
      const dataStr = JSON.stringify(dados, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'servicos_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Importa dados JSON e atualiza localStorage + interface
    document.getElementById('importFile').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = function(evt){
        try {
          const importData = JSON.parse(evt.target.result);
          if(typeof importData !== 'object' || importData === null) throw new Error('Arquivo inválido');

          dados = importData;
          salvarDados();

          // Atualizar interface
          mostrarCalendario();
          mostrarServicos();
          mostrarResumoMensal();

          alert('Dados importados com sucesso!');
        } catch(err) {
          alert('Erro ao importar arquivo JSON: ' + err.message);
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    });

    // Inicialização
    // Seleciona o dia de hoje automaticamente ao carregar a página
    window.onload = () => {
      const hoje = new Date();
      dataSelecionada = formatDateLocal(hoje);
      document.getElementById('dataSelecionada').textContent = hoje.toLocaleDateString('pt-BR');
      document.getElementById('formulario').style.display = 'block';
      mostrarCalendario();
      mostrarServicos();
      mostrarResumoMensal();
    }
  </script>

</body>
</html>
